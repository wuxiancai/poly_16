<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>交易统计分析</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f5f5f5;
            padding: 20px;
        }
        
        .container {
            max-width: 1000px;
            margin: 0 auto;
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }
        
        .header {
            background: #007bff;
            color: white;
            padding: 20px;
            text-align: center;
        }
        
        .header h1 {
            font-size: 1.8em;
            margin: 0;
        }
        
        .content {
            padding: 20px;
        }
        
        .controls {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            align-items: center;
        }
        
        .controls input, .controls select {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
        }
        
        .btn {
            background: #007bff;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
        }
        
        .btn:hover {
            background: #0056b3;
        }
        
        .chart-container {
            background: white;
            border: 1px solid #ddd;
            border-radius: 5px;
            padding: 20px;
            margin-bottom: 20px;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 8px;
            min-width: 0;
        }
        
        @media (max-width: 1000px) {
            .stats-grid {
                grid-template-columns: repeat(3, 1fr);
            }
        }
        
        @media (max-width: 600px) {
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }
        
        .stats-card {
            background: #f8f9fa;
            border: 1px solid #ddd;
            border-radius: 5px;
            padding: 10px 6px;
            text-align: center;
            min-width: 0;
            max-width: 100%;
            box-sizing: border-box;
        }
        
        .stats-card h3 {
            color: #495057;
            margin-bottom: 6px;
            font-size: 0.8em;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            margin-top: 0;
        }
        
        .stats-value {
            color: #007bff;
            font-size: 1.1em;
            font-weight: bold;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .loading {
            text-align: center;
            padding: 20px;
            color: #6c757d;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>交易统计分析</h1>
        </div>
        
        <div class="content">
            <div class="controls">
                <input type="date" id="dateInput" />
                <select id="viewType">
                    <option value="daily">日统计</option>
                    <option value="weekly">周统计</option>
                    <option value="monthly">月统计</option>
                </select>
                <button class="btn" onclick="updateChart()">更新数据</button>
            </div>
            
            <div class="chart-container">
                <div id="loadingIndicator" class="loading" style="display: none;">正在加载数据...</div>
                <canvas id="tradeChart" width="800" height="400"></canvas>
            </div>
            
            <div class="stats-grid">
                <div class="stats-card">
                    <h3>总交易次数</h3>
                    <div class="stats-value" id="totalTrades">0</div>
                </div>
                <div class="stats-card">
                    <h3>最活跃时段</h3>
                    <div class="stats-value" id="peakHour">--:--</div>
                </div>
                <div class="stats-card">
                    <h3>平均每小时</h3>
                    <div class="stats-value" id="avgPerHour">0</div>
                </div>
                <div class="stats-card">
                    <h3>凌晨(0-8点)</h3>
                    <div class="stats-value" id="earlyMorningTrades">0</div>
                </div>
                <div class="stats-card">
                    <h3>上午(8-16点)</h3>
                    <div class="stats-value" id="morningTrades">0</div>
                </div>
                <div class="stats-card">
                    <h3>下午(16-22点)</h3>
                    <div class="stats-value" id="afternoonTrades">0</div>
                </div>
                <div class="stats-card">
                    <h3>晚上(22-24点)</h3>
                    <div class="stats-value" id="eveningTrades">0</div>
                </div>
            </div>
            
            <!-- 复利计算功能 -->
            <div style="text-align: center; border-radius: 6px; background: white; margin-top: 20px; padding: 20px; border: 1px solid #ddd;">
                <h3 style="margin-bottom: 15px; color: #495057;">复利计算器</h3>
                <style>
                    .compound-table {
                        width: 100%;
                        border-collapse: collapse;
                        background: linear-gradient(135deg, #A8C0FF, #C6FFDD);
                        border-radius: 6px;
                        overflow: hidden;
                        table-layout: fixed; 
                        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
                    }
                    .compound-table th {
                        color: black;
                        padding: 6px 4px;
                        text-align: center;
                        font-weight: 400;
                        font-size: 13px;
                        text-shadow: 0 1px 2px rgba(0,0,0,0.2);
                        border: none;
                    }
                    .compound-table td {
                        padding: 4px 6px;
                        text-align: center;
                        border-bottom: 1px solid #f0f2f5;
                        font-size: 13px;
                        transition: all 0.3s ease;
                    }
                    .compound-table input {
                        width: 100%;
                        border: none;
                        text-align: center;
                        background: transparent;
                        font-size: 13px;
                        font-weight: 400;
                        padding: 4px 4px;
                        border-radius: 6px;
                        transition: all 0.3s ease;
                    }
                    .compound-table input:focus {
                        outline: none;
                        background: #f0f4ff;
                        box-shadow: 0 0 0 2px rgba(102, 126, 234, 0.3);
                    }
                    .month-result {
                        font-weight: 400;
                        color: #2c3e50;
                        border-radius: 6px;
                        padding: 8px 4px;
                        margin: 2px;
                        transition: all 0.3s ease;
                        min-height: 20px;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                    }
                </style>
                <table class="compound-table">
                    <thead>
                        <tr>
                            <th>本金</th>
                            <th>日复利</th>
                            <th>30 天</th>
                            <th>60 天</th>
                            <th>90 天</th>
                            <th>120 天</th>
                            <th>150 天</th>
                            <th>180 天</th>
                            <th>210 天</th>
                            <th>240 天</th>
                            <th>270 天</th>
                            <th>300 天</th>
                            <th>330 天</th>
                            <th>360 天</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr id="compound-results-row">
                            <td><input type="number" id="compound-principal" value="500" min="0" step="0.01"></td>
                            <td><input type="text" id="compound-rate" value="1.5%"></td>
                            <td><div id="compound-month-1" class="month-result"></div></td>
                            <td><div id="compound-month-2" class="month-result"></div></td>
                            <td><div id="compound-month-3" class="month-result"></div></td>
                            <td><div id="compound-month-4" class="month-result"></div></td>
                            <td><div id="compound-month-5" class="month-result"></div></td>
                            <td><div id="compound-month-6" class="month-result"></div></td>
                            <td><div id="compound-month-7" class="month-result"></div></td>
                            <td><div id="compound-month-8" class="month-result"></div></td>
                            <td><div id="compound-month-9" class="month-result"></div></td>
                            <td><div id="compound-month-10" class="month-result"></div></td>
                            <td><div id="compound-month-11" class="month-result"></div></td>
                            <td><div id="compound-month-12" class="month-result"></div></td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    
    <script>
        let tradeChart;
        
        // 注册datalabels插件
        Chart.register(ChartDataLabels);
        
        // 初始化页面
        document.addEventListener('DOMContentLoaded', function() {
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('dateInput').value = today;
            
            initChart();
            updateChart();
            initCompoundCalculator();
            
            // 每5分钟自动刷新
            setInterval(updateChart, 300000);
        });
        
        // 初始化图表
        function initChart() {
            const ctx = document.getElementById('tradeChart').getContext('2d');
            
            tradeChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: Array.from({length: 24}, (_, i) => `${i.toString().padStart(2, '0')}:00`),
                    datasets: [{
                        label: '交易次数',
                        data: new Array(24).fill(0),
                        backgroundColor: new Array(24).fill('rgba(0, 123, 255, 0.6)'),
                        borderColor: new Array(24).fill('rgba(0, 123, 255, 1)'),
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        },
                        datalabels: {
                            anchor: 'end',
                            align: 'top',
                            formatter: function(value) {
                                return value > 0 ? value : '';
                            },
                            color: '#333',
                            font: {
                                weight: 'bold'
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                stepSize: 1
                            }
                        }
                    }
                }
            });
        }
        
        // 复利计算相关函数
        function saveCompoundData() {
            const principal = document.getElementById('compound-principal').value;
            const rate = document.getElementById('compound-rate').value;
            localStorage.setItem('compound_principal', principal);
            localStorage.setItem('compound_rate', rate);
        }
        
        function loadCompoundData() {
            const savedPrincipal = localStorage.getItem('compound_principal');
            const savedRate = localStorage.getItem('compound_rate');
            
            if (savedPrincipal !== null) {
                document.getElementById('compound-principal').value = savedPrincipal;
            }
            if (savedRate !== null) {
                document.getElementById('compound-rate').value = savedRate;
            }
        }
        
        function calculateCompound() {
            const principal = parseFloat(document.getElementById('compound-principal').value) || 0;
            const rateValue = document.getElementById('compound-rate').value;
            const dailyRate = parseFloat(rateValue.replace('%', '')) / 100 || 0;
            
            // 计算每个月的复利金额（每月按30天计算）
            for (let month = 1; month <= 12; month++) {
                const days = month * 30;
                const amount = principal * Math.pow(1 + dailyRate, days);
                const cell = document.getElementById('compound-month-' + month);
                if (cell) {
                    cell.textContent = amount.toLocaleString('zh-CN', {maximumFractionDigits: 0});
                }
            }
        }
        
        // 初始化复利计算功能
        function initCompoundCalculator() {
            // 监听输入变化
            const principalInput = document.getElementById('compound-principal');
            const rateInput = document.getElementById('compound-rate');
            
            if (principalInput) {
                principalInput.addEventListener('input', function() {
                    calculateCompound();
                    saveCompoundData();
                });
            }
            
            if (rateInput) {
                rateInput.addEventListener('input', function() {
                    let value = this.value.replace('%', '');
                    if (value && !isNaN(value)) {
                        this.value = value + '%';
                    }
                    calculateCompound();
                    saveCompoundData();
                });
            }
            
            // 加载保存的数据并计算
            loadCompoundData();
            calculateCompound();
        }

        // 更新图表数据
        async function updateChart() {
            const dateInput = document.getElementById('dateInput').value;
            const viewType = document.getElementById('viewType').value;
            
            if (!dateInput) return;
            
            document.getElementById('loadingIndicator').style.display = 'block';
            document.getElementById('tradeChart').style.display = 'none';
            
            try {
                const response = await fetch(`/api/stats?date=${dateInput}&type=${viewType}`);
                const data = await response.json();
                
                // 更新图表
                if (data.hourly_data) {
                    tradeChart.data.datasets[0].data = data.hourly_data;
                    
                    // 找到最活跃的小时
                    const maxValue = Math.max(...data.hourly_data);
                    const peakHours = [];
                    data.hourly_data.forEach((value, index) => {
                        if (value === maxValue && value > 0) {
                            peakHours.push(index);
                        }
                    });
                    
                    // 设置颜色：最活跃小时为红色，其他为蓝色
                    const backgroundColors = new Array(24).fill('rgba(0, 123, 255, 0.6)');
                    const borderColors = new Array(24).fill('rgba(0, 123, 255, 1)');
                    
                    peakHours.forEach(hour => {
                        backgroundColors[hour] = 'rgba(255, 99, 132, 0.6)';
                        borderColors[hour] = 'rgba(255, 99, 132, 1)';
                    });
                    
                    tradeChart.data.datasets[0].backgroundColor = backgroundColors;
                    tradeChart.data.datasets[0].borderColor = borderColors;
                    tradeChart.update();
                }
                
                // 更新统计
                document.getElementById('totalTrades').textContent = data.total_trades || 0;
                document.getElementById('peakHour').textContent = data.peak_hour || '--:--';
                document.getElementById('avgPerHour').textContent = (data.avg_per_hour || 0).toFixed(1);
                
                const periods = data.period_stats || {};
                document.getElementById('earlyMorningTrades').textContent = periods.early_morning?.count || 0;
                document.getElementById('morningTrades').textContent = periods.morning?.count || 0;
                document.getElementById('afternoonTrades').textContent = periods.afternoon?.count || 0;
                document.getElementById('eveningTrades').textContent = periods.evening?.count || 0;
                
                document.getElementById('loadingIndicator').style.display = 'none';
                document.getElementById('tradeChart').style.display = 'block';
                
            } catch (error) {
                console.error('获取数据失败:', error);
                document.getElementById('loadingIndicator').textContent = '加载失败';
            }
        }
    </script>
</body>
</html>
